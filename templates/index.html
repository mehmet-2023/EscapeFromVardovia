<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="assets/vardovia__logo.png">
  <title>Escape from Vardovia</title>
  <style>
    :root {
      --bg: #0c0c0c;
      --panel-bg: #141414;
      --panel-border: #2a0a0a;
      --text: #e0e0e0;
      --text-dim: #999999;
      --text-glow: #ff4d4d;
      --accent: #cc0000;
      --accent-dark: #990000;
      --border: #2a0a0a;
      --glow: rgba(204, 0, 0, 0.4);
      --header-bg: rgba(10, 0, 0, 0.8);
      --concrete-green: #6E7F73;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    @font-face {
      font-family: 'Cinzel';
      src: url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
    }

    body {
      font-family: 'Cinzel', 'Times New Roman', serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      background-image:
        linear-gradient(rgba(40, 0, 0, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(40, 0, 0, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      letter-spacing: 0.5px;
    }

    .container {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 8px;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    .game-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
      background: rgba(15, 5, 5, 0.3);
      border: 1px solid var(--panel-border);
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 3px double var(--accent);
      flex-shrink: 0;
    }

    .game-title {
      display: flex;
      align-items: center;
      font-size: clamp(1.2rem, 5vw, 1.8rem);
      text-transform: uppercase;
      letter-spacing: 2px;
      color: #ff3333;
      text-shadow: 0 0 8px rgba(255, 60, 60, 0.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 75vw;
      font-weight: 700;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(20, 0, 0, 0.7), rgba(30, 0, 0, 0.6));
      border: 1px solid var(--concrete-green);
      border-radius: 4px;
      position: relative;
      transition: all 0.3s ease;
      animation: titleGlow 3s infinite alternate;
    }

    @keyframes titleGlow {
      0% {
        box-shadow: 0 0 10px rgba(204, 0, 0, 0.3);
      }

      100% {
        box-shadow: 0 0 20px rgba(204, 0, 0, 0.6);
      }
    }

    .game-title::before {
      content: '';
      display: inline-block;
      width: 32px;
      height: 32px;
      background-image: url('/static/assets/vardovia__logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 0 5px rgba(255, 60, 60, 0.7));
    }

    .settings-btn {
      background: rgba(20, 0, 0, 0.4);
      border: 1px solid rgba(204, 0, 0, 0.3);
      border-radius: 4px;
      font-size: clamp(20px, 6vw, 24px);
      color: #ff4d4d;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover {
      background: rgba(40, 0, 0, 0.6);
      color: #ff6666;
      transform: rotate(90deg);
    }

    .settings-btn:hover {
      transform: rotate(45deg);
    }

    .status-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      padding: 12px 15px;
      background: linear-gradient(to right, rgba(20, 0, 0, 0.9), rgba(30, 0, 0, 0.85));
      border: 1px solid var(--panel-border);
      border-image: linear-gradient(90deg, var(--accent), var(--concrete-green)) 1;
      font-weight: bold;
      font-size: clamp(0.85rem, 2.5vw, 0.95rem);
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .status-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--concrete-green), transparent);
      animation: scanline 3s linear infinite;
    }

    @keyframes scanline {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .status-bar::-webkit-scrollbar {
      display: none;
    }

    .status-bar::before,
    .status-bar::after {
      content: "‚òÖ";
      color: var(--accent);
      font-size: clamp(0.9rem, 3.5vw, 1.2rem);
      flex-shrink: 0;
    }

    .status-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      border: 1px solid rgba(110, 127, 115, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .status-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 50%, rgba(255, 255, 255, 0.05) 100%);
      pointer-events: none;
    }

    .status-item:hover {
      background: rgba(110, 127, 115, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    #image-panel {
      background: var(--panel-bg);
      padding: 12px;
      border: 3px double var(--accent);
      text-align: center;
      box-shadow: 0 0 15px rgba(204, 0, 0, 0.3);
      flex-shrink: 0;
      width: 100%;
    }

    #image-panel h3 {
      color: var(--accent);
      margin-bottom: 10px;
      font-size: clamp(1.1rem, 4.5vw, 1.3rem);
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    #game-image {
      max-width: 100%;
      max-height: 280px;
      object-fit: contain;
      border: 2px solid var(--border);
      box-shadow: 0 0 20px var(--glow);
    }

    #no-image {
      color: var(--text-dim);
      font-style: italic;
      padding: 25px 10px;
      font-size: clamp(0.95rem, 4vw, 1.1rem);
    }

    .text-panel {
      flex: 1;
      background: var(--panel-bg);
      padding: clamp(12px, 4vw, 25px);
      border: 3px double var(--accent);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
      min-height: 0;
      width: 100%;
    }

    #game-text {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: rgba(10, 5, 5, 0.7);
      border: 1px solid rgba(60, 10, 10, 0.5);
      font-family: 'Cinzel', 'Times New Roman', serif;
      font-size: 1.05rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #f0f0f0;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      letter-spacing: 0.3px;
    }

    .message {
      padding: clamp(8px, 2.5vw, 12px) clamp(12px, 3.5vw, 18px);
      background: rgba(20, 0, 0, 0.2);
      border-left: 4px solid var(--accent);
      line-height: 1.6;
      font-size: clamp(0.95rem, 3.8vw, 1.1rem);
      color: var(--text);
      word-break: break-word;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.5s ease-out forwards;
      margin-bottom: 4px;
    }

    .message.typing {
      border-left: 4px solid var(--concrete-green);
      position: relative;
      overflow: hidden;
    }

    .message.typing::after {
      content: '|';
      display: inline-block;
      animation: blink 1s infinite;
      color: var(--concrete-green);
      font-weight: bold;
      margin-left: 2px;
    }

    .player-message {
      border-left-color: var(--concrete-green);
      background: rgba(20, 30, 20, 0.3);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }
    }

    .message::before {
      content: ">";
      color: var(--accent);
      margin-right: 10px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .player-message {
      background: rgba(204, 0, 0, 0.15);
      border-left-color: var(--accent);
      color: #ff8888;
      font-style: italic;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--panel-bg);
      border-top: 3px double var(--accent);
      flex-shrink: 0;
      width: 100%;
    }

    #action-input {
      width: 100%;
      padding: 14px;
      background: var(--bg);
      border: 2px solid var(--border);
      color: var(--text);
      font-family: inherit;
      font-size: clamp(0.95rem, 4vw, 1.05rem);
    }

    #action-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 12px rgba(204, 0, 0, 0.5);
    }

    #submit-btn {
      padding: 0 25px;
      background: linear-gradient(to bottom, #cc0000, #990000);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    #submit-btn:hover:not(:disabled) {
      background: linear-gradient(to bottom, #e60000, #b30000);
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
    }

    #submit-btn:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    #submit-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }

    @media (min-width: 640px) {
      .input-area {
        flex-direction: row;
      }

      #submit-btn {
        align-self: center;
        width: auto;
        padding: 14px 35px;
      }
    }

    .intro-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      background: linear-gradient(rgba(0, 0, 0, 0.95), rgba(10, 0, 0, 0.9));
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      color: var(--text);
    }

    .intro-logo {
      width: 180px;
      height: 180px;
      margin-bottom: 20px;
      background-image: url('/static/assets/vardovia__logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 0 15px rgba(255, 60, 60, 0.8));
      animation: pulse 3s infinite alternate;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        filter: drop-shadow(0 0 15px rgba(255, 60, 60, 0.8));
      }

      100% {
        transform: scale(1.05);
        filter: drop-shadow(0 0 25px rgba(255, 80, 80, 1));
      }
    }

    .intro-content {
      width: 95vw;
      max-width: 800px;
      padding: clamp(25px, 7vw, 50px);
      border: 4px double var(--accent);
      background: rgba(10, 10, 10, 0.95);
      text-align: center;
      position: relative;
    }

    .intro-content::before {
      content: "‚òÖ‚òÖ‚òÖ";
      position: absolute;
      color: var(--accent);
      font-size: clamp(1.2rem, 5vw, 1.8rem);
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
    }

    .intro-title {
      font-size: clamp(2.2rem, 9vw, 3.5rem);
      color: var(--accent);
      letter-spacing: 7px;
      margin-bottom: 20px;
      animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 15px var(--accent);
      }

      to {
        text-shadow: 0 0 35px var(--accent), 0 0 55px var(--accent);
      }
    }

    .intro-subtitle {
      font-size: clamp(1rem, 4vw, 1.3rem);
      margin-bottom: 35px;
      line-height: 1.7;
      color: var(--text-dim);
    }

    .start-button {
      padding: clamp(12px, 3.5vw, 18px) clamp(35px, 9vw, 55px);
      font-size: clamp(1.1rem, 4.5vw, 1.5rem);
      background: transparent;
      color: var(--accent);
      border: 3px solid var(--accent);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .start-button:hover {
      background: var(--accent);
      color: #000;
    }

    .loading {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      color: var(--text);
      font-size: clamp(1rem, 4.5vw, 1.2rem);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 7px solid var(--panel-bg);
      border-top: 7px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .settings-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel-bg);
      padding: clamp(20px, 7vw, 35px);
      border: 4px double var(--accent);
      z-index: 1001;
      width: 90vw;
      max-width: 420px;
      display: none;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.9);
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--accent);
    }

    .settings-header h3 {
      font-size: clamp(1.2rem, 4.5vw, 1.5rem);
      color: var(--accent);
      letter-spacing: 3px;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--accent);
      font-size: clamp(26px, 7vw, 30px);
      cursor: pointer;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 65px;
      height: 35px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #444;
      transition: .4s;
      border-radius: 35px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 28px;
      width: 28px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(30px);
    }

    .setting-item {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: clamp(1rem, 4vw, 1.1rem);
    }

    .language-select {
      background: var(--panel-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 5px;
      border-radius: 4px;
      font-family: inherit;
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      max-width: 80%;
      word-wrap: break-word;
      line-height: 1.5;
      position: relative;
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }

    @keyframes slideIn {
      from {
        transform: translateY(10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .message-fade {
      animation: slideIn 0.3s ease-out forwards;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      z-index: 1000;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay"></div>

  <div id="intro-screen" class="intro-screen">
    <div class="intro-logo"></div>
    <h1 class="intro-title" data-translate="game_title">Escape from Vardovia</h1>
    <p class="intro-subtitle">
      <span data-translate="intro_1">1989. Behind the Iron Curtain.</span><br>
      <span data-translate="intro_2">You are Arsen Dvorak, an investigative journalist captured by the Vardovian secret
        police.</span><br>
      <span data-translate="intro_3">Your only chance is to escape before they break you.</span>
    </p>
    <button id="start-button" class="start-button" data-translate="begin_escape">Begin Escape</button>
    </p>
  </div>
  </div>

  <div class="loading" id="loading-overlay">
    <div class="spinner"></div>
    <div data-translate="processing">Processing action...</div>
  </div>

  <div class="settings-panel" id="settings-panel">
    <div class="settings-header">
      <h3 data-translate="settings">Settings</h3>
      <button class="close-btn" id="close-settings">√ó</button>
    </div>
    <div class="setting-item">
      <label class="switch">
        <input type="checkbox" id="image-generation-toggle">
        <span class="slider"></span>
      </label>
      <span data-translate="enable_image_generation">Enable Image Generation</span>
    </div>
    <div class="setting-item">
      <label for="language-select" data-translate="language">Language:</label>
      <select id="language-select" class="language-select">
        <option value="en">English</option>
        <option value="tr">T√ºrk√ße</option>
      </select>
    </div>
  </div>

  <div class="container hidden" id="game-container">
    <header>
      <h1 class="game-title" data-translate="game_title_upper">ESCAPE FROM VARDOVIA</h1>
      <button class="settings-btn" id="settings-btn">‚öô</button>
    </header>

    <div class="status-bar">
      <div class="status-item">‚ù§Ô∏è <span id="health">90</span>%</div>
      <div class="status-item">‚ö†Ô∏è <span id="danger">1</span>/10</div>
      <div class="status-item">üìç <span id="location">Basement</span></div>
      <div class="status-item">üïí <span id="time">22:00</span></div>
    </div>

    <div class="image-panel" id="image-panel">
      <h3 data-translate="current_scene">Current Scene</h3>
      <img id="game-image" src="" alt="Scene" style="display:none;">
      <div id="no-image" data-translate="no_image">No image available</div>
    </div>

    <div class="text-panel" id="game-text">
      <div class="message" id="welcome-message-1"></div>
      <div class="message" id="welcome-message-2"></div>
    </div>

    <div class="input-area">
      <input type="text" id="action-input" data-placeholder="What do you do?" placeholder="What do you do?"
        autocomplete="off" spellcheck="false">
      <button id="submit-btn" data-translate="submit">Submit</button>
    </div>
  </div>

  <script>
    const introScreen = document.getElementById('intro-screen');
    const startButton = document.getElementById('start-button');
    const gameContainer = document.getElementById('game-container');
    const gameText = document.getElementById('game-text');
    const actionInput = document.getElementById('action-input');
    const submitBtn = document.getElementById('submit-btn');
    const gameImage = document.getElementById('game-image');
    const noImage = document.getElementById('no-image');
    const imagePanel = document.getElementById('image-panel');
    const loadingOverlay = document.getElementById('loading-overlay');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const closeSettings = document.getElementById('close-settings');
    const overlay = document.getElementById('overlay');
    const imageToggle = document.getElementById('image-generation-toggle');
    const languageSelect = document.getElementById('language-select');
    const savedImageSetting = localStorage.getItem('imageGenerationEnabled');
    if (savedImageSetting !== null) {
      imageToggle.checked = savedImageSetting === 'true';
    }

    const translations = {
      en: {
        game_title: "Escape from Vardovia",
        game_title_upper: "ESCAPE FROM VARDOVIA",
        intro_1: "1989. Behind the Iron Curtain.",
        intro_2: "You are Arsen Dvorak, an investigative journalist captured by the Vardovian secret police.",
        intro_3: "Your only chance is to escape before they break you.",
        begin_escape: "Begin Escape",
        settings: "Settings",
        enable_image_generation: "Enable Image Generation",
        language: "Language:",
        submit: "Submit",
        processing: "Processing action...",
        no_image: "No image available",
        current_scene: "Current Scene",
        welcome_1: "1989, somewhere in Eastern Europe... You are Arsen Dvorak, a journalist investigating the corrupt regime of Vardovia. After publishing an expos√©, you were captured and imprisoned in a secret facility. You've just woken up in a dark basement, your head pounding from the drugs they gave you.",
        welcome_2: "Type your actions below. Examples: 'examine room', 'try the door', 'hide'"
      },
      tr: {
        game_title: "Vardovia'dan Ka√ßƒ±≈ü",
        game_title_upper: "VARDOVIA'DAN KA√áI≈û",
        intro_1: "1989. Demir Perde'nin ardƒ±nda.",
        intro_2: "Sen, Vardovya gizli polisi tarafƒ±ndan yakalanan bir ara≈ütƒ±rmacƒ± gazetecisin, Arsen Dvorak.",
        intro_3: "Seni kƒ±rmadan √∂nce ka√ßman i√ßin tek ≈üansƒ±n bu.",
        begin_escape: "Ka√ßƒ±≈üa Ba≈üla",
        settings: "Ayarlar",
        enable_image_generation: "G√∂rsel √úretimini Etkinle≈ütir",
        language: "Dil:",
        submit: "G√∂nder",
        processing: "ƒ∞≈üleniyor...",
        no_image: "G√∂rsel yok",
        current_scene: "Mevcut Sahne",
        welcome_1: "1989, Doƒüu Avrupa'da bir yerde... Sen, Vardovya'nƒ±n yozla≈ümƒ±≈ü rejimini ara≈ütƒ±ran bir gazetecisin, Arsen Dvorak. Bir if≈üayƒ± yayƒ±nladƒ±ktan sonra yakalandƒ±n ve gizli bir tesiste tutuklu kaldƒ±n. Az √∂nce karanlƒ±k bir bodrum katƒ±nda uyandƒ±n, kafan sana verdikleri ila√ßlardan zonkluyor.",
        welcome_2: "A≈üaƒüƒ±ya eylemlerini yaz. √ñrnekler: 'odayƒ± incele', 'kapƒ±yƒ± dene', 'saklan'"
      }
    };

    let currentLanguage = localStorage.getItem('language') || 'tr';

    function initializeWelcomeMessages() {
      const welcome1 = document.getElementById('welcome-message-1');
      const welcome2 = document.getElementById('welcome-message-2');

      if (translations[currentLanguage]) {
        welcome1.textContent = translations[currentLanguage].welcome_1 || translations['en'].welcome_1;
        welcome2.textContent = translations[currentLanguage].welcome_2 || translations['en'].welcome_2;
      } else {
        welcome1.textContent = translations['en'].welcome_1;
        welcome2.textContent = translations['en'].welcome_2;
      }
    }

    function setLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('language', lang);
      document.documentElement.lang = lang;

      document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
          element.textContent = translations[lang][key];
        } else if (translations['en'][key]) {
          element.textContent = translations['en'][key];
        }
      });

      document.querySelectorAll('[data-placeholder]').forEach(element => {
        const key = element.getAttribute('data-placeholder');
        if (translations[lang] && translations[lang][key]) {
          element.placeholder = translations[lang][key];
        } else if (translations['en'][key]) {
          element.placeholder = translations['en'][key];
        }
      });

      initializeWelcomeMessages();
    }

    async function translateText(text, currentLang, targetLang) {
      try {
        const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${currentLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
        const data = await response.json();
        return data[0].map(item => item[0]).join('');
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    async function translateAndAddMessage(text, isPlayer = false) {
      if (isPlayer) {
        addMessage(text, true);
        if (currentLanguage !== 'en') {
          const translatedText = await translateText(text, 'tr', 'en');
          return translatedText;
        }
        return text;
      } else {
        if (currentLanguage !== 'en') {
          const translatedText = await translateText(text, 'en', currentLanguage);
          addMessage(translatedText, false);
        } else {
          addMessage(text, false);
        }
        return text;
      }
    }

    function updateImagePanel() {
      if (imageToggle.checked) {
        imagePanel.style.display = 'block';
        if (gameImage.src && gameImage.src !== location.href) {
          gameImage.style.display = 'block';
          noImage.style.display = 'none';
        } else {
          gameImage.style.display = 'none';
          noImage.style.display = 'block';
        }
      } else {
        imagePanel.style.display = 'none';
      }

      const currentSceneText = translations[currentLanguage]?.current_scene || 'Current Scene';
      const sceneTitle = imagePanel.querySelector('h3');
      if (sceneTitle) {
        sceneTitle.textContent = currentSceneText;
      }
    }

    function updateImage(url) {
      if (url) {
        gameImage.src = url;
        gameImage.style.display = imageToggle.checked ? 'block' : 'none';
        noImage.style.display = imageToggle.checked ? 'none' : 'block';
      } else {
        gameImage.style.display = 'none';
        noImage.style.display = imageToggle.checked ? 'block' : 'none';
      }
      updateImagePanel();
    }

    function cleanText(text) {
      return text.replace(/\[IMAGE_PROMPT:[^\]]*\]/g, '').trim();
    }

    async function addMessage(text, isPlayer = false) {
      const messageDiv = document.createElement('div');
      const cleanTextContent = cleanText(text);
      const displayText = isPlayer ? '> ' + cleanTextContent : cleanTextContent;

      messageDiv.className = `message ${isPlayer ? 'player-message' : ''} message-fade`;
      messageDiv.textContent = displayText;
      messageDiv.style.opacity = '0';
      messageDiv.style.transition = 'opacity 0.5s ease-in-out';
      
      gameText.appendChild(messageDiv);
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      void messageDiv.offsetWidth;
      messageDiv.style.opacity = '1';
      return Promise.resolve();
    }

    function showLoading() {
      loadingOverlay.style.display = 'flex';
      loadingOverlay.querySelector('div:last-child').textContent = translations[currentLanguage]?.processing || 'Processing...';
      submitBtn.disabled = true;
      actionInput.disabled = true;
    }

    function hideLoading() {
      loadingOverlay.style.display = 'none';
      submitBtn.disabled = false;
      actionInput.disabled = false;
      actionInput.focus();
    }

    function updateStatus(state) {
      document.getElementById('health').textContent = state.health ?? 90;
      document.getElementById('danger').textContent = state.danger ?? 1;
      document.getElementById('location').textContent = state.location ?? 'Basement';
      document.getElementById('time').textContent = state.time ?? '22:00';
    }

    async function handleSubmit() {
      const action = actionInput.value.trim();
      if (!action) return;
      const translatedAction = currentLanguage === 'en' ? action : await translateText(action, 'tr', 'en');
      addMessage(action, true);
      actionInput.value = '';
      showLoading();

      try {
        const res = await fetch('/api/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: translatedAction,
            image_generation_enabled: imageToggle.checked
          })
        });

        const data = await res.json();

        if (!res.ok) {
          let errorMsg = data.error || data.detail || data.message || 'An unknown error occurred';

          if (typeof errorMsg === 'string') {
            if (errorMsg.includes('ERROR_JSON:')) {
              errorMsg = errorMsg.split('ERROR_JSON:')[1]?.trim() || errorMsg;
            }
            errorMsg = errorMsg
              .replace(/^"|"$/g, '')
              .replace(/^\[|\]$/g, '')
              .trim();

            if (errorMsg.length > 100) {
              const sentenceEnd = errorMsg.match(/[.!?]/);
              if (sentenceEnd) {
                errorMsg = errorMsg.substring(0, sentenceEnd.index + 1);
              } else {
                errorMsg = errorMsg.substring(0, 100) + '...';
              }
            }
          }

          await translateAndAddMessage(errorMsg, false);
        } else {
          if (data.narration) {
            await translateAndAddMessage(data.narration, false);
          }
          if (data.state) {
            updateStatus(data.state);
          }
          updateImage(data.image_url || '');
        }
      } catch (err) {
        let errorMsg = err.message || 'An unknown error occurred';

        try {
          const errorObj = JSON.parse(errorMsg);
          errorMsg = errorObj.error || errorObj.detail || errorObj.message || errorMsg;
        } catch (e) {
          const errorParts = errorMsg.split(':').map(part => part.trim());
          errorMsg = errorParts.length > 1 ? errorParts.slice(1).join(': ') : errorMsg;
        }

        errorMsg = errorMsg
          .replace(/^"|"$/g, '')
          .replace(/^\[|\]$/g, '')
          .trim();

        await translateAndAddMessage(errorMsg, false);
      } finally {
        hideLoading();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeWelcomeMessages();
    });

    startButton.addEventListener('click', () => {
      introScreen.style.display = 'none';
      gameContainer.classList.remove('hidden');
      actionInput.focus();
      updateImagePanel();
    });

    submitBtn.addEventListener('click', handleSubmit);
    actionInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') handleSubmit();
    });

    function openSettings() {
      settingsPanel.style.display = 'block';
      overlay.style.display = 'block';
    }

    function closeSettingsFunc() {
      settingsPanel.style.display = 'none';
      overlay.style.display = 'none';
    }

    settingsBtn.addEventListener('click', openSettings);
    closeSettings.addEventListener('click', closeSettingsFunc);
    overlay.addEventListener('click', closeSettingsFunc);

    imageToggle.addEventListener('change', () => {
      localStorage.setItem('imageGenerationEnabled', imageToggle.checked);
      updateImagePanel();

      fetch('/api/settings/image_generation', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: imageToggle.checked })
      });
    });

    languageSelect.value = currentLanguage;
    languageSelect.addEventListener('change', (e) => {
      setLanguage(e.target.value);
    });

    setLanguage(currentLanguage);
    updateImagePanel();

    fetch('/api/settings/image_generation', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: imageToggle.checked })
    });

    imageToggle.addEventListener('change', updateImagePanel);

    updateStatus({});
    updateImagePanel();
  </script>
</body>

</html>